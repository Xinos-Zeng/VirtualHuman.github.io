# 虚拟人类(VirtualHuman)项目设计方案

## 整体风格定位
视觉风格：深色科技感（Dark Mode + Neon Glow）
交互动效：流畅过渡 + 动态粒子流 + 悬停高亮
布局方式：响应式 + 多层级模态视图（Modal Layering）

## 前端原则
1. 定性大于定量： 不展示精密图表，展示趋势、状态和关系。
2. 视觉分层： Level 1（宏观人体）负责吸引注意力和定位；Level 2（因果拓扑）负责解释逻辑。
3. 松耦合数据： 界面能够容忍数据缺失，只要有节点和关系，就能画出图，不依赖复杂的物理坐标。

## 模块一：Level 1 - 宏观人体
主体： 一个半透明的、充满科技感的人体 3D 模型  

1. 视觉实现  
状态表达（去数值化）：
● 正常态（Normal）： 器官呈现冷静的蓝色/青色微光，伴随缓慢的呼吸动效（Opacity 0.4 -> 0.6 循环）。
● 警示态（Warning）： 器官呈现黄色脉冲，跳动频率加快。
● 危急态（Critical）： 器官呈现红色高亮，并向周围扩散“故障噪点”效果。
信息  
用户一开始是看到一个人体的图；每个器官着色，整体右侧有个报告；影响特别大的器官弹出对话框标注关键信息。

2. 交互逻辑  
鼠标悬空在器官时，器官高亮，显示简短的信息。
鼠标点击器官时，镜头平滑推近该器官，背景虚化压暗，无缝过渡到 Level 2 界面。


## 模块二：Level 2 - Agent因果拓扑台
● 中心节点（大圆）： 当前选中的器官（如：肝脏）。固定在画面中央。
● 内部节点（中圆）： 该器官内的组织/细胞（如：肝细胞、免疫细胞）。漂浮在中心节点内部。
● 外部节点（外围圆）： 影响该器官的其他要素（如：外部器官、药物）。围绕在中心节点外围。连接线（Edge）： 代表“影响/因果”。

颜色（性质）：

前端实现： 连线采用流光动画（Flow Animation）。红色流光表示危害，绿色流光表示支持。
粗细（强度）： 分桶 高中低，不用数值
对应 1px, 3px, 6px 的线条粗细。不要显示具体数值，只让用户直观感到“这根红线很粗，问题很严重”。


右侧报告栏 (Context Panel)
内容： 纯文本结论 + 文献引用。

## 1. 项目背景

虚拟人类(VH)是一个通过Agent来模拟人体内的器官、组织、细胞、靶点四个层级的系统。当输入药物信息和患者信息时，VH的层级架构会自顶向下传递各个节点模拟出的信息，从而实现对药物在人体内作用过程的模拟。

## 2. 项目目标
基于前端原则和整体风格，开发出模块一和模块二。

### 2.1 各级Agent节点说明
1. 器官 - 包括肠道、肝脏、肾脏、心脏、CNS
2. 组织 - 无需具体命名，包括肠道组织、肝脏组织、肾脏组织、心脏组织、CNS组织
3. 细胞 - 无需具体命名，包括肠道细胞、肝脏细胞、肾脏细胞、心脏细胞、CNS细胞
4. 靶点 - 无需具体命名，例如肠道靶点1，肠道靶点2，...
在器官-组织-细胞层级间都是1对1关系，细胞-靶点为1对多关系。


## 3. 系统架构

### 3.1 前端架构

- **React** - 核心UI框架
- **React Router** - 实现层级化页面导航
- **D3.js/Three.js** - 实现复杂的人体可视化和动态连接线
- **Styled-components** - 组件样式管理
- **Context API** - 状态管理

## 4. 核心数据结构规范 (Data Schema)
前端开发应基于“数据驱动”原则。在后端 Agent API 就绪前，我们需要定义严格的 TypeScript 接口。

### 4.1 节点通用定义 (Agent Node)
这是一个递归或层级化的结构，用于统一管理从器官到靶点的所有节点。

```typescript
// 定义节点层级类型
export type AgentLevel = 'ORGAN' | 'TISSUE' | 'CELL' | 'TARGET';

// 定义健康状态（对应视觉设计的颜色）
export type HealthStatus = 'NORMAL' | 'WARNING' | 'CRITICAL';

export interface AgentNode {
  id: string;                // 唯一标识 (e.g., "organ-liver-01")
  name: string;              // 显示名称 (e.g., "肝脏")
  level: AgentLevel;         // 层级
  status: HealthStatus;      // 状态，决定颜色和特效
  
  // 核心数值 (不直接显示，但驱动 UI 表现，如跳动频率、透明度)
  metrics: {
    activity: number;        // 0-1.0，活跃度
    stress: number;          // 0-1.0，压力值/受损程度
  };

  description?: string;      // 简短描述 (Hover 时显示)
  
  // 层级关系 (Level 1 点击进入 Level 2 的依据)
  childrenIds?: string[];    // 下级节点 ID 列表
  parentId?: string;         // 上级节点 ID
}
```

### 4.2 拓扑关系定义 (Topology Edge)
用于 Level 2 的因果关系图。

```typescript
export interface InteractionEdge {
  id: string;
  sourceId: string;
  targetId: string;
  type: 'SUPPORT' | 'DAMAGE'; // 决定流光颜色 (绿/红)
  intensity: 'LOW' | 'MEDIUM' | 'HIGH'; // 决定粗细 (1px/3px/6px)
  description?: string;       // 悬停在线上时显示的因果解释
}
```

## 5. 技术选型与实现细节 (Implementation Details)

### 5.1 模块一：Level 1 (3D 宏观人体)
*   **引擎**: `React Three Fiber (R3F)`
*   **模型策略**: 
    *   **初期 (MVP)**: 使用 **Low-Poly（低多边形）** 或 **几何抽象体**（透明胶囊体代表人体，发光球体代表器官）。
    *   **材质**: 使用 `MeshPhysicalMaterial` 实现“半透明玻璃感”。
        *   `transmission`: 0.6 (透光)
        *   `roughness`: 0.2 (光滑)
        *   `emissive`: 基于 `status` 动态改变颜色 (青/黄/红)。
*   **动画**: 使用 `useFrame` 钩子实现“呼吸动效”。
*   **交互**: 使用 `drei` 库的 `<Html>` 组件实现 Hover 时的浮动标签，避免复杂的 3D 文字渲染。

### 5.2 模块二：Level 2 (2D/3D 混合拓扑)
*   **引擎**: 建议使用 `D3.js` (Force Simulation) 结合 `SVG` 或 `Canvas` 渲染。
*   **流光连线 (Flow Animation)**:
    *   **SVG 实现方案**: 利用 `stroke-dasharray` 和 `stroke-dashoffset` CSS 动画。
    *   **逻辑**: 
        *   红色连线 (`DAMAGE`): 粒子流动快，颜色刺眼。
        *   绿色连线 (`SUPPORT`): 粒子流动平缓。

### 5.3 状态管理与路由
*   **路由策略**: 
    *   `/` -> Level 1 (全览)
    *   `/organ/:organId` -> Level 2 (详情)
*   **Context**: 需要一个 `SimulationContext` 全局存储所有 Agent 的实时状态。

## 6. 组件架构 (Component Architecture)

```text
src/
├── assets/             # 3D 模型 (.glb), 贴图
├── components/
│   ├── layout/         # UI 框架
│   │   ├── HUD.tsx     # 抬头显示 (右上角状态，右侧报告栏)
│   │   └── Modal.tsx   # 警告弹窗
│   ├── level1/         # 3D 宏观视图
│   │   ├── HumanBody.tsx   # R3F Canvas 容器
│   │   ├── OrganMesh.tsx   # 单个器官组件 (处理呼吸、颜色)
│   │   └── CameraController.tsx # 处理点击后的镜头推近
│   └── level2/         # 拓扑视图
│       ├── TopologyGraph.tsx # D3 力导向图容器
│       ├── AgentNode.tsx     # 节点渲染 (圆)
│       └── FluxLink.tsx      # 连线渲染 (流光效果)
├── services/
│   ├── mockData.ts     # 静态模拟数据
│   └── simulation.ts   # 模拟数据变化的逻辑 (自顶向下传递)
└── types/              # TS 类型定义
```

## 7. 分阶段开发计划 (Dev Roadmap)

### Phase 1: 骨架与数据 (预计 1-2 天)
*   **目标**: 跑通数据流，无复杂 UI。
*   **任务**:
    1.  搭建 React + TypeScript + Vite 脚手架。
    2.  实现 `MockDataService`，生成包含器官-组织-细胞的层级数据。
    3.  建立 Global Context，实现一个简单的 Debug 面板。
*   **交付物**: 一个只有文字列表的页面，但数据结构完整。

### Phase 2: Level 2 拓扑核心 (预计 2-3 天)
*   **目标**: 完成“因果拓扑台”。
*   **任务**:
    1.  集成 D3.js 力导向图。
    2.  实现“中心节点-周边节点”的布局算法。
    3.  实现 SVG 连线的流光动画。
*   **交付物**: 可交互的 2D 拓扑图。

### Phase 3: Level 1 3D 视觉 (预计 3-4 天)
*   **目标**: 完成 3D 首页。
*   **任务**:
    1.  引入 React Three Fiber。
    2.  放置抽象人体模型。
    3.  实现 Shader 或 Material 动画。
    4.  实现点击器官 -> Level 2 跳转。
*   **交付物**: 3D 首页，无缝跳转到 Level 2。

### Phase 4: 整合与 UI 抛光 (预计 2 天)
*   **目标**: 统一风格，增加沉浸感。
*   **任务**:
    1.  实现“右侧报告栏”和“关键信息弹窗”。
    2.  全局样式调整：Dark Mode，Neon Glow。
    3.  转场动画。

### Phase 5: Level 1 底图拟真与标注对齐 (预计 1 天)
*   **目标**: 用真实人体插画替换抽象躯干，节点标注与插画器官位置精确对齐，交互保持数据驱动。
*   **任务**:
    1.  将 `assets/body.png` 作为 Level 1 底图居中展示，保持纵横比与响应式缩放。
    2.  提供器官坐标表（百分比），与 Agent 节点绑定，悬停/点击高亮。
    3.  状态色与选中态样式同步（NORMAL/WARNING/CRITICAL 的配色与光晕）。
    4.  预留坐标微调入口（配置化），必要时可依据设计稿或标注工具导出的坐标快速更新。
*   **交付物**:
    - 首页展示 `body.png` 底图，五个器官标注与插画位置匹配，可点击进入 Level 2。
    - 不同分辨率下标注不漂移（使用百分比定位并保持原图宽高比）。
    - 文档中记录坐标来源、调整方式与状态色规范。

### Phase 6: 沉浸视觉加强与交互优化 (预计 1-2 天)
*   **目标**: 让首页背景与人体插画无缝融合，增加星空闪烁效果；节点标注采用空心粒子/光晕动效匹配状态说明（Normal/Warning/Critical）；优化交互体验，修复 bug，增加缩放拖动与悬停提示。
*   **任务**:
   1.  **星空背景**: 使用 `radial-gradient` 绘制 18+ 个白点星空，尺寸 1-2px，不透明度 0.5-1.0，添加 twinkle 动画（4s 缓慢闪烁），z-index 置顶确保可见性。
   2.  **人体底图融合**: 去掉容器边框/描边，全黑背景沉浸式展示，底图居中，配合 drop-shadow 增强层次感。
   3.  **空心粒子节点**: 标注改为 12px 空心圆环（2px 边框），配合 inset 阴影与泛光效果；Normal 缓慢呼吸蓝光（3.6s）、Warning 加速脉冲黄光（2s）、Critical 红色强脉冲 + 噪点闪烁（1.2s）。
   4.  **Critical Alert Bug 修复**: 改用 `Set<string>` 管理已确认的 critical 节点，只在首次变为 CRITICAL 时弹窗，确认后不再重复；节点恢复正常时清除标记。
   5.  **缩放拖动交互**: 支持鼠标滚轮缩放（0.5x - 3x）、左键拖动平移，右下角显示缩放比例与重置按钮。
   6.  **悬停弹窗**: 鼠标悬停在节点时，在鼠标附近弹出浮窗，展示器官名称、状态徽章、Activity/Stress 数据和描述信息（复用侧边栏内容）。
*   **交付物**:
   - 星空闪烁明显可见，层次丰富且不干扰主体内容。
   - 人体底图无边框、居中，节点呈现空心光晕，视觉更轻盈、更具科技感。
   - Critical Alert 只在首次状态变化时弹出，无重复干扰。
   - 用户可自由缩放/拖动人体图查看细节，操作流畅无卡顿。
   - 悬停任意节点即可快速预览关键信息，无需点击切换侧边栏。

### Phase 7: 递归层级视图与调试台分离 (预计 2-3 天)
*   **目标**: 将调试功能独立为专门界面；重构 Level2 为递归层级视图，支持双击从器官->组织->细胞层层深入，配合器官背景图实现"放大-虚化"的沉浸式探索体验。
*   **任务**:
   1.  **调试台独立界面**: 将原 Level2 左侧的节点状态调试卡片迁移到独立的 "Debug Console" 界面，从 Level1 右上角按钮进入，展示所有节点列表及状态切换按钮。
   2.  **双击进入层级**: Level1 人体视图支持双击器官节点，触发"放大-虚化"动画过渡，进入该器官的下级层级（组织层级）。
   3.  **递归层级视图（HierarchyView）**:
      - 显示当前节点的所有子节点（如器官->组织，组织->细胞）。
      - 每个实际节点生成 3-5 个视觉副本，随机分布在视窗中，模拟细胞/组织的不均匀分布效果。
      - 背景显示器官的高分辨率图片（虚化+暗化处理），增强沉浸感。
      - 支持双击子节点继续放大进入下一层级（如双击组织进入细胞层级）。
      - 左上角返回按钮，回退到上一层级或返回 Level1。
   4.  **器官背景图素材目录**: 创建 `public/assets/organs/` 目录，预留 heart-bg.jpg、liver-bg.jpg、kidney-bg.jpg、intestine-bg.jpg、brain-bg.jpg 等占位，配合 HierarchyView 的背景图映射逻辑。
   5.  **层级导航历史**: 记录用户的层级导航路径（如 器官A -> 组织B -> 细胞C），支持按返回按钮逐级回退。
   6.  **视觉优化**: 层级视图中的节点保持空心粒子光晕效果，配合 float 动画，营造"微观世界"的动态感。
*   **交付物**:
   - Debug Console 独立界面，清晰展示所有节点及调试控制，不干扰主视图。
   - Level1 双击器官可流畅进入递归层级视图，无缝过渡动画。
   - 递归层级视图支持器官->组织->细胞的多级探索，每级显示对应背景图与多个视觉副本节点。
   - 器官背景图目录已创建，含 README 说明命名规范与建议规格。
   - 用户可通过返回按钮逐级回退或直接返回 Level1，导航逻辑清晰流畅。
   - 节点视觉效果统一，层级视图中节点呈现微观动态感。